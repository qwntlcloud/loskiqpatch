name: Patch v6 final

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  MIKRO_NPK_SIGN_PUBLIC_KEY: C293CED638A2A33C681FC8DE98EE26C54EADC5390C2DFCE197D35C83C416CF59
  MIKRO_LICENSE_PUBLIC_KEY: 8E1067E4305FCDC0CFBF95C10F96E5DFE8C49AEF486BD1A4E2E96C27F01E3E32
  CUSTOM_NPK_SIGN_PRIVATE_KEY: 7D008D9B80B036FB0205601FEE79D550927EBCA937B7008CC877281F2F8AC640
  CUSTOM_NPK_SIGN_PUBLIC_KEY: 28F886E32C141123126CFBCAD56766E99D1720CEB1F12BE2468BEBE7662FBEDB
  CUSTOM_LICENSE_PRIVATE_KEY: 9DBC845E9018537810FDAE62824322EEE1B12BAD81FCA28EC295FB397C61CE0B
  CUSTOM_LICENSE_PUBLIC_KEY: 723A34A6E3300F23E4BAA06156B9327514AEC170732655F16E04C17928DD770F
  LATEST_VERSION: 6.42.6

jobs:
  patch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mkisofs xorriso qemu-utils extlinux zip unzip rsync curl

      # ================= ISO =================
      - name: Download ISO
        run: |
          curl -s -o mikrotik.iso \
          https://download.mikrotik.com/routeros/${LATEST_VERSION}/mikrotik-${LATEST_VERSION}.iso

      - name: Patch ISO
        run: |
          sudo mkdir iso new_iso
          sudo mount -o loop,ro mikrotik.iso iso
          sudo rsync -a iso/ new_iso/
          sudo umount iso
          sudo rm -rf iso

          sudo -E python3 patch.py kernel new_iso/isolinux/initrd.rgz
          for f in new_iso/*.npk; do
            sudo -E python3 patch.py npk "$f"
          done

          sudo mkisofs -o mikrotik-${LATEST_VERSION}-patched.iso \
            -V "MikroTik ${LATEST_VERSION}" \
            -b isolinux/isolinux.bin \
            -c isolinux/boot.cat \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -R -J new_iso

          mkdir all_packages
          cp new_iso/*.npk all_packages/
          zip -j all_packages-x86-${LATEST_VERSION}-patched.zip all_packages/*.npk

      # ================= INSTALL IMAGE =================
      - name: Download install-image
        run: |
          curl -s -o install-image.zip \
          https://download.mikrotik.com/routeros/${LATEST_VERSION}/install-image-${LATEST_VERSION}.zip

      - name: Patch install-image
        run: |
          unzip install-image.zip
          sudo modprobe nbd
          sudo qemu-nbd -c /dev/nbd0 install-image-${LATEST_VERSION}.img
          sudo mkdir mnt
          sudo mount /dev/nbd0 mnt

          sudo -E python3 patch.py kernel mnt/initrd.rgz
          for f in mnt/*.npk; do
            sudo -E python3 patch.py npk "$f"
          done

          sudo umount mnt
          sudo qemu-nbd -d /dev/nbd0

          mv install-image-${LATEST_VERSION}.img install-image-${LATEST_VERSION}-patched.img

          for fmt in qcow2 vmdk vhd vhdx vdi; do
            qemu-img convert -f raw -O $fmt \
              install-image-${LATEST_VERSION}-patched.img \
              install-image-${LATEST_VERSION}-patched.$fmt
            zip install-image-${LATEST_VERSION}-patched.$fmt.zip \
              install-image-${LATEST_VERSION}-patched.$fmt
            rm install-image-${LATEST_VERSION}-patched.$fmt
          done

          zip install-image-${LATEST_VERSION}-patched.img.zip \
            install-image-${LATEST_VERSION}-patched.img
          rm install-image-${LATEST_VERSION}-patched.img

      # ================= CHR =================
      - name: Download CHR
        run: |
          curl -s -o chr.img.zip \
          https://download.mikrotik.com/routeros/${LATEST_VERSION}/chr-${LATEST_VERSION}.img.zip

      - name: Patch CHR
        run: |
          unzip chr.img.zip
          cp chr-${LATEST_VERSION}.img chr-${LATEST_VERSION}-patched.img

          for fmt in qcow2 vmdk vhd vhdx vdi; do
            qemu-img convert -f raw -O $fmt \
              chr-${LATEST_VERSION}-patched.img \
              chr-${LATEST_VERSION}-patched.$fmt
            zip chr-${LATEST_VERSION}-patched.$fmt.zip \
              chr-${LATEST_VERSION}-patched.$fmt
            rm chr-${LATEST_VERSION}-patched.$fmt
          done

          zip chr-${LATEST_VERSION}-patched.img.zip \
            chr-${LATEST_VERSION}-patched.img
          rm chr-${LATEST_VERSION}-patched.img

      # ================= DEBUG =================
      - name: List output files
        run: ls -lh

      # ================= RELEASE =================
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.LATEST_VERSION }}
          name: "RouterOS ${{ env.LATEST_VERSION }} patched"
          make_latest: true
          files: |
            mikrotik-${{ env.LATEST_VERSION }}-patched.iso
            install-image-${{ env.LATEST_VERSION }}-patched.*.zip
            chr-${{ env.LATEST_VERSION }}-patched.*.zip
            all_packages-x86-${{ env.LATEST_VERSION }}-patched.zip
